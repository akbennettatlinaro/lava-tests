metadata:
    name: ansiblepatchmetrics
    format: "Lava-Test-Shell Test Definition 1.0"
    description: "Install linaro patchmetrics using Ansible"
params:
    blankvar: empty
run:
    steps:
        - echo 'Acquire::http::Proxy "http://192.168.1.141:3142";'> /etc/apt/apt.conf.d/80cache
        - echo 'change hostname'
        - echo 'lava-server' > /etc/hostname
        - hostname lava-server
        
        - echo 'Install Dependencies'
        - apt-get update
        - apt-get install -y git-core
        - apt-get install -y python-pip python-dev
        
        - echo 'Install Ansible'
        - pip install ansible
        
        - echo 'Create /root/hosts'
        - . ./ansible/hosts.sh
        
        - echo 'Create /root/host_vars'
        - . ./ansible/host_vars.sh
        
        - echo 'Create /root/secrets.yml file'
        - . ./ansible/secrets.sh
        - mkdir -p /srv
        - cd /srv
        - git clone https://git.linaro.org/infrastructure/linaro-patchmetrics.git
        - cd linaro-patchmetrics/ansible
        
        - echo 'run ansible on local server'
        - echo lava-server >> hosts
        - cp /root/secrets.yml .
        - cp /root/localhost host_vars/lava-server
        - ansible-playbook -c local -s -i hosts site.yml -l lava-server
        - ansible-playbook -c local -s -i hosts site.yml -l lava-server --tag pip
        - service apache2 restart
        - curl -o https://lava-server/ --insecure
        - lava-test-case patchmetrics-server-verification --shell grep "by Linaro engineers" test
        
